# Changes - 2025-11-27

## Stage-Based Environment Management

### What Changed

Added multi-environment (stage) support to pushenv, allowing teams to manage separate `.env` files for different stages like development, staging, and production.

**Files Modified:**
- `src/utils/config.ts` - Added `StageConfig` interface, `stages` map to `ProjectConfig`, and helper functions
- `src/cli.ts` - Added `--stage` / `-s` option to push/pull commands, added `list-stages` command
- `src/commands/init.ts` - Added stage selection prompts and per-stage env file path configuration
- `src/commands/push.ts` - Updated to accept stage parameter and upload to stage-specific R2 path
- `src/commands/pull.ts` - Updated to accept stage parameter and download from stage-specific R2 path
- `src/utils/r2-client.ts` - Updated R2 functions to accept stage parameter with new key format

**Files Added:**
- `src/commands/list-stages.ts` - New command to show configured stages and their status

### Usage

```bash
# Initialize with stage selection
pushenv init

# Push/pull specific stages
pushenv push --stage production
pushenv pull --stage staging

# List all configured stages
pushenv list-stages
```

---

## Zero-File Execution (`pushenv run`)

### What Changed

Added `pushenv run` command that downloads, decrypts, and injects environment variables directly into a subprocess without creating any .env file on disk.

**Files Added:**
- `src/commands/run.ts` - Main run command logic with signal handling
- `src/utils/env-parser.ts` - Utility to parse .env content into key-value object

**Files Modified:**
- `src/cli.ts` - Added run command with --stage, --verbose, --dry-run options
- `README.md` - Added documentation for run command

### Why It Changed

Zero-file execution is a security game-changer:
- Secrets never touch disk - they exist only in process memory
- No .env file to accidentally commit or leak
- When the process exits, secrets are gone
- Perfect for CI/CD and production deployments
- Ultimate security for paranoid teams

### How It Works

1. Fetches encrypted data from R2
2. Decrypts in memory using stored key (or prompts for passphrase)
3. Parses .env content into key-value object
4. Spawns child process with merged environment variables
5. Forwards signals (SIGINT, SIGTERM, SIGHUP) to child process
6. Exits with child's exit code

### Usage

```bash
# Basic usage (development stage by default)
pushenv run "npm start"

# With specific stage
pushenv run --stage production "npm start"
pushenv run -s staging "python manage.py runserver"

# Dry run - preview what would be injected
pushenv run --dry-run -s production "npm start"

# Verbose - show variable names being injected
pushenv run --verbose -s production "npm start"
```

### Command Options

| Option | Description |
|--------|-------------|
| `-s, --stage <stage>` | Stage/environment to use (default: development) |
| `-v, --verbose` | Show injected variable names (not values) |
| `--dry-run` | Show what would be injected without running |

### Developer Notes

**Testing:**
```bash
npm run build
pushenv run --dry-run "echo test"
pushenv run --verbose "node -e 'console.log(process.env.DATABASE_URL)'"
```

**Signal Handling:**
- Ctrl+C (SIGINT) is properly forwarded to child process
- SIGTERM and SIGHUP are also forwarded
- Exit codes are preserved from child process

