#!/usr/bin/env node
/**
 * Build-time script to embed R2 credentials from .env into the package
 * This allows the package to work without requiring users to configure R2
 */

import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";
import dotenv from "dotenv";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const projectRoot = path.resolve(__dirname, "../");
const envPath = path.join(projectRoot, ".env");

// Load .env from project root
if (!fs.existsSync(envPath)) {
  console.error("Error: .env file not found in project root");
  console.error("Please create a .env file with your R2 credentials before building.");
  process.exit(1);
}

dotenv.config({ path: envPath });

const endpoint = process.env["R2_ENDPOINT"];
const accessKey = process.env["R2_ACCESS_KEY"];
const secretKey = process.env["R2_SECRET_KEY"] || process.env["R2_SECRET_ACCESS_KEY"];
const bucket = process.env["R2_BUCKET"] || "pushenv";

if (!endpoint || !accessKey || !secretKey) {
  console.error("Error: Missing R2 credentials in .env file");
  console.error("Required: R2_ENDPOINT, R2_ACCESS_KEY, R2_SECRET_KEY (or R2_SECRET_ACCESS_KEY)");
  process.exit(1);
}

// Create the config file with embedded credentials (TypeScript source that gets compiled)
const configContent = `/**
 * R2 credentials - embedded at build time
 * DO NOT EDIT THIS FILE - it is generated from your .env during build
 */

export const R2_CREDENTIALS = {
  endpoint: ${JSON.stringify(endpoint)},
  accessKey: ${JSON.stringify(accessKey)},
  secretKey: ${JSON.stringify(secretKey)},
  bucket: ${JSON.stringify(bucket)},
} as const;
`;

// Write to src/config so it gets compiled with the rest of the code
const srcConfigPath = path.join(projectRoot, "src", "config", "r2-credentials-embedded.ts");
const srcConfigDir = path.dirname(srcConfigPath);

// Ensure src/config directory exists
if (!fs.existsSync(srcConfigDir)) {
  fs.mkdirSync(srcConfigDir, { recursive: true });
}

fs.writeFileSync(srcConfigPath, configContent, "utf8");

// Also embed version from package.json
const packageJsonPath = path.join(projectRoot, "package.json");
const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, "utf8"));
const versionContent = `/**
 * Package version - embedded at build time
 * DO NOT EDIT THIS FILE - it is generated from package.json during build
 */

export const PACKAGE_VERSION = ${JSON.stringify(packageJson.version)};
`;

const versionFilePath = path.join(projectRoot, "src", "config", "version.ts");
fs.writeFileSync(versionFilePath, versionContent, "utf8");

console.log("âœ“ R2 credentials and version embedded into source (will be compiled)");

